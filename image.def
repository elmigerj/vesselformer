Bootstrap: docker
From: nvidia/cuda:11.3.1-devel-ubuntu20.04

%post
    # Set timezone and locale
    TZ=Europe/Berlin
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    echo "LC_ALL=en_US.UTF-8" >> /etc/environment

    # Update and install system packages
    apt-get update -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        libgsl-dev \
        libboost-all-dev \
        vim \
        nvidia-nsight \
        python3.7 \
        python3.7-dev \
        python3.7-distutils \
        python3-pip \
        python3-setuptools \
        python3-tk \
        wget

    # Set Python 3.7 as the default python3
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 1
    update-alternatives --set python3 /usr/bin/python3.7

    # Upgrade pip
    python3 -m pip install --upgrade pip

    # Install PyTorch and other required packages
    pip3 install torch>=2.0 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu113
    pip3 install \
        loguru==0.5.3 \
        numpy==1.19.5 \
        sknw==0.14 \
        scikit_image==0.17.2 \
        monai==0.7.0 \
        matplotlib==3.2.1 \
        pyvista==0.33.2 \
        scipy==1.5.4 \
        open3d==0.11.2 \
        MedPy==0.4.0 \
        mmcv_full==1.3.15 \
        timm==0.4.12 \
        tqdm==4.62.3 \
        ignite==1.1.0 \
        einops==0.3.2 \
        mmcv==1.6.0 \
        PyYAML==6.0 \
        pytorch-ignite==0.4.9 \
        tensorboard

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*


    # Install MultiScaleDeformableAttention
    cd /itet-stor/elmigerj/net_scratch/vesselformer/models/ops
    python3 setup.py build install

    # Add a script to determine CUDA visible devices and run training
    cat << EOF > /usr/local/bin/run_training.sh
#!/bin/bash
CUDA_DEVICES=$(nvidia-smi --query-gpu=index --format=csv,noheader | tr '\n' ',' | sed 's/,$//')
NUM_DEVICES=$(echo \$CUDA_DEVICES | tr ',' '\n' | wc -l)

python3 /itet-stor/elmigerj/net_scratch/vesselformer/train.py \
    --config configs/synth_3D.yaml \
    --cuda_visible_device \$CUDA_DEVICES \
    --nproc_per_node \$NUM_DEVICES
EOF

    chmod +x /usr/local/bin/run_training.sh

%environment
    export CUDA_HOME="/usr/local/cuda"
    export LC_ALL=C
    export PYTHONPATH=/itet-stor/elmigerj/net_scratch/vesselformer:$PYTHONPATH

%runscript
    /usr/local/bin/run_training.sh
